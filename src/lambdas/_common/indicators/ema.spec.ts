import { ArrayCandle } from "../../lambda.types";
import { ema } from "./ema";

describe('ema', () => {
	it('calculate ema from array of candles', () => {
		const candles = [[0,0,1],[0,0,3],[0,0,4],[0,0,5],[0,0,6],[0,0,7],[0,0,8],[0,0,9],[0,0,10],[0,0,11],[0,0,12],[0,0,13],[0,0,14],[0,0,15]];
		// @ts-ignore
		const result = ema(candles, 8);

		expect( result.slice(0, 7) ).toEqual([0,0,0,0,0,0,0]);
		expect( result.length ).toBe(candles.length);
		expect( truncate(result[7]) ).toBe('5.375');
		expect( truncate(result[8]) ).toBe('6.402');
		expect( truncate(result[9]) ).toBe('7.424');
		expect( truncate(result[10]) ).toBe('8.441');
		expect( truncate(result[11]) ).toBe('9.454');
		expect( truncate(result[12]) ).toBe('10.464');
		expect( truncate(result[13]) ).toBe('11.472');
	});

	it('should return expected results', () => {
		const actual = ema( testCandles, 26 );
		console.log( actual );
		expect( actual ).toEqual( expectedResults );
	});
})

function truncate( n: number) {
	return (Math.floor(n * 1000) / 1000).toString();
}

// period 26
const expectedResults = [ 
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	45569.399999999994,
	45815.79259259259,
	46035.93388203018,
	46106.28692780572,
	46182.85826648678,
	46382.06876526553,
	46597.49330117179,
	46850.9086121961,
	47080.922789070464,
	47428.10628617636,
	47817.75026497811,
	47748.44283794269,
	47624.36559068768,
	47532.90147285897,
	47333.59025264719,
	47170.909493191844,
	47088.71619739986,
	46931.463145740614,
	46947.34735716724,
	47036.60310848818,
	47092.18065600758,
	47105.33023704406,
	47194.557626892645,
	47197.76076564134,
	46886.28959781605,
	46428.83110908893,
	46216.53250841568,
	46118.25602631081,
	45874.91854288038,
	45640.48753970405,
	45460.0514256519,
	45216.81057930731,
	44907.298684543806,
	44656.743226429455,
	44593.184468916166,
	44857.6671008483,
	45065.39546374843,
	45299.82542939669,
	45591.93465684878,
	46028.606163748875,
	46719.09459606378,
	47244.88758894794,
	47742.34036013698,
	48276.99662975646,
	48751.10799051524,
	49399.137028254845,
	49888.837989124855,
	50443.8277677082,
	50957.44052565574,
	51749.941227459014,
	52425.752988387976,
	53099.882396655536,
	53761.94295986624,
	54541.42125913541,
	55392.856721421675,
	55896.94140872377,
	56251.79760067016,
	56625.50888950941,
	56940.84156436057,
	57395.72737440793,
	57611.6142355629,
	57677.42799589157,
	57894.91481101072,
	58217.25445463956,
	58487.554124666254,
	58701.81678209838,
	58868.68220564665,
	59195.424264487636,
	59473.01505971078,
	59619.38431454702,
	59722.11140235835,
	59856.495742924395,
	60112.888650855915,
	60664.51171375548,
	61114.9256608847 ]

const testCandles: ArrayCandle[] = [ [ 1627862400, 39889.9, 39152.3, 40440.8, 38700, 3504.70836076 ],
  [ 1627948800, 39152.4, 38163, 39791.1, 37655, 2952.96871944 ],
  [ 1628035200, 38163, 39749, 39950, 37527.9, 3259.23334718 ],
  [ 1628121600, 39749, 40886.4, 41403.5, 37355, 4715.12051213 ],
  [ 1628208000, 40886.5, 42823.9, 43401.9, 39900, 5168.03548276 ],
  [ 1628294400, 42861.7, 44610.7, 44721.8, 42495, 4617.87051633 ],
  [ 1628380800, 44612.1, 43845.6, 45348, 43320, 3667.28592934 ],
  [ 1628467200, 43845.6, 46307.1, 46484.1, 42827.7, 5654.00111905 ],
  [ 1628553600, 46300.8, 45595.1, 46688, 44666, 3081.95009446 ],
  [ 1628640000, 45606.9, 45571.7, 46736.4, 45373.5, 3504.45567656 ],
  [ 1628726400, 45570, 44401.1, 46195.4, 43800.1, 3567.19495677 ],
  [ 1628812800, 44401.1, 47823.3, 47898.5, 44251.2, 3816.14935216 ],
  [ 1628899200, 47823.2, 47115.2, 48164, 46042.5, 2970.19914208 ],
  [ 1628985600, 47111.8, 47019.3, 47385, 45550, 2101.35909566 ],
  [ 1629072000, 47023.7, 45926.3, 48072.6, 45697.4, 2739.39057218 ],
  [ 1629158400, 45926.2, 44672.2, 47172.3, 44401.2, 3291.66244845 ],
  [ 1629244800, 44672.3, 44714.7, 46000, 44250, 3211.81374825 ],
  [ 1629331200, 44720.2, 46765.3, 47062.2, 44000, 2627.81529413 ],
  [ 1629417600, 46770.8, 49345.4, 49400, 46662.9, 3541.23372143 ],
  [ 1629504000, 49345.5, 48865.4, 49790, 48267.6, 2697.47503994 ],
  [ 1629590400, 48865.3, 49293.6, 49532.3, 48058.1, 1740.18402632 ],
  [ 1629676800, 49293.4, 49517.3, 50500, 49060, 3119.26102911 ],
  [ 1629763200, 49517.2, 47725.4, 49867, 47601.1, 3149.29294249 ],
  [ 1629849600, 47715.1, 48991.3, 49245, 47146.3, 2608.10974936 ],
  [ 1629936000, 48991.4, 46848.9, 49350, 46284.8, 3175.30347867 ],
  [ 1630022400, 46846.7, 49074.9, 49174.9, 46386.4, 2672.22120021 ],
  [ 1630108800, 49074.9, 48895.7, 49314, 48393.9, 1300.71840626 ],
  [ 1630195200, 48895.7, 48787.7, 49653.9, 47800, 2232.52440756 ],
  [ 1630281600, 48787.7, 46985.7, 48900, 46861.6, 2528.07798392 ],
  [ 1630368000, 46987.1, 47140, 48248, 46715, 2213.35684346 ],
  [ 1630454400, 47140, 48872.2, 49137.3, 46550, 2574.82496729 ],
  [ 1630540800, 48872.1, 49290.3, 50372.9, 48622, 3436.66451617 ],
  [ 1630627200, 49290.2, 50018.6, 51009.7, 48356, 3628.82427331 ],
  [ 1630713600, 50022.9, 49956.1, 50559.5, 49363.6, 1604.31873364 ],
  [ 1630800000, 49956.1, 51767.9, 51890.9, 49512.4, 1807.72703411 ],
  [ 1630886400, 51768, 52688.3, 52800, 51025.5, 2977.7958553 ],
  [ 1630972800, 52688.2, 46882.1, 52900, 42000, 8784.1975246 ],
  [ 1631059200, 46889.5, 46073.4, 47362.4, 44444, 3486.85659567 ],
  [ 1631145600, 46064.3, 46389.6, 47399, 45498.7, 2319.02280703 ],
  [ 1631232000, 46389.7, 44842.2, 47035.8, 44135.2, 3303.07297039 ],
  [ 1631318400, 44842.2, 45137.4, 45992.4, 44741, 1239.97337633 ],
  [ 1631404800, 45148.8, 46061.3, 46487.9, 44770, 1202.06666163 ],
  [ 1631491200, 46061.3, 44965.8, 46879, 43374.9, 3673.51904919 ],
  [ 1631577600, 44965.8, 47145.9, 47260, 44700, 2114.13267011 ],
  [ 1631664000, 47110.5, 48152.3, 48481, 46744, 2151.18720019 ],
  [ 1631750400, 48152.3, 47786.9, 48485.8, 47030.1, 2289.67394172 ],
  [ 1631836800, 47786.9, 47269.7, 48185.9, 46745.7, 2007.83571876 ],
  [ 1631923200, 47269.7, 48309.9, 48800, 47077.9, 1277.08379196 ],
  [ 1632009600, 48306.9, 47237.8, 48379.1, 46851.2, 1219.51050215 ],
  [ 1632096000, 47247.3, 42992.9, 47307.7, 42510, 5755.78647313 ],
  [ 1632182400, 42992.9, 40710.6, 43624.7, 39579, 7259.61267188 ],
  [ 1632268800, 40710.5, 43562.8, 44024.2, 40600, 3430.28601932 ],
  [ 1632355200, 43563.3, 44889.8, 45000, 43111.6, 4171.04314642 ],
  [ 1632441600, 44888.9, 42833.2, 45153, 40750, 4407.09719872 ],
  [ 1632528000, 42831.7, 42710.1, 43021.7, 41705.1, 1058.57183586 ],
  [ 1632614400, 42710.1, 43204.6, 43930.4, 40802.7, 2250.76323745 ],
  [ 1632700800, 43175.2, 42176.3, 44333, 42120.7, 1977.89964159 ],
  [ 1632787200, 42176.3, 41038.4, 42750, 40875.6, 2231.71257206 ],
  [ 1632873600, 41016, 41524.8, 42579.9, 40772.2, 1707.74975383 ],
  [ 1632960000, 41523.9, 43798.7, 44100, 41423.7, 3053.23090867 ],
  [ 1633046400, 43798.7, 48163.7, 48475, 43300.3, 6512.03024789 ],
  [ 1633132800, 48168.8, 47662, 48349.2, 47487.1, 1621.17649347 ],
  [ 1633219200, 47657.3, 48230.2, 49257.9, 47131.1, 1653.13750113 ],
  [ 1633305600, 48228.6, 49243.3, 49500, 46895.8, 2828.92263936 ],
  [ 1633392000, 49239.2, 51487, 51888, 49084.3, 4047.31458904 ],
  [ 1633478400, 51492.9, 55350.2, 55770, 50366.4, 7379.34314845 ],
  [ 1633564800, 55350.2, 53817.3, 55352.2, 53399.8, 3074.65033031 ],
  [ 1633651200, 53817.4, 53960.5, 56114.1, 53685, 2595.44015122 ],
  [ 1633737600, 53960.9, 54960.2, 55515.1, 53700, 1220.39617158 ],
  [ 1633824000, 54967.4, 54677.5, 56500, 54118.6, 2295.10818143 ],
  [ 1633910400, 54678.9, 57499.5, 57837.7, 54450.2, 2787.09612904 ],
  [ 1633996800, 57482.8, 56010.1, 57673.8, 54019.2, 3699.83673303 ],
  [ 1634083200, 55991.9, 57381.2, 57777, 54271.2, 3017.4304618 ],
  [ 1634169600, 57381.2, 57377.6, 58580.4, 56825, 2594.17461395 ],
  [ 1634256000, 57357.1, 61656.2, 62887.5, 56888.5, 5168.07233194 ],
  [ 1634342400, 61669.8, 60873.4, 62400, 60162, 1963.72806446 ],
  [ 1634428800, 60868.5, 61526.5, 61674.3, 58900.2, 2142.26443974 ],
  [ 1634515200, 61526.1, 62037.7, 62672.6, 59900, 3406.19056422 ],
  [ 1634601600, 62009.6, 64284.9, 64448, 61320, 3564.49206667 ],
  [ 1634688000, 64291.6, 66035.8, 66982.2, 63546.2, 3549.62292947 ],
  [ 1634774400, 66035.7, 62198, 66637.8, 54100, 6480.46357995 ],
  [ 1634860800, 62197.4, 60687.5, 63757.9, 60034.2, 2968.70503913 ],
  [ 1634947200, 60687.5, 61296.9, 61713.9, 59610.4, 1276.37709253 ],
  [ 1635033600, 61297.6, 60882.5, 61450, 59523, 1443.19001317 ],
  [ 1635120000, 60865.1, 63081.8, 63700, 60674, 2256.60065874 ],
  [ 1635206400, 63081.7, 60310.2, 63288, 59824.2, 2574.26550076 ],
  [ 1635292800, 60325.1, 58500.1, 61477.1, 58140.6, 3954.31807153 ],
  [ 1635379200, 58500.1, 60613.5, 62490, 57948, 4393.97638147 ],
  [ 1635465600, 60604.5, 62246.5, 62950, 60223.5, 2725.25641851 ],
  [ 1635552000, 62246.4, 61866.3, 62359.2, 60741.1, 1202.80701854 ],
  [ 1635638400, 61879.2, 61380.1, 62422.8, 60051, 1518.03039144 ],
  [ 1635724800, 61380.1, 60954.5, 62500, 59449.1, 2649.55088957 ],
  [ 1635811200, 60954.5, 63279.7, 64327, 60665.9, 2728.46636 ],
  [ 1635897600, 63279.8, 62942.9, 63550.4, 60810.3, 2573.43392899 ],
  [ 1635984000, 62938, 61449, 63115, 60644.2, 1869.32799097 ],
  [ 1636070400, 61448.9, 61006.2, 62631.9, 60804.4, 1430.9820694 ],
  [ 1636156800, 61007.4, 61536.3, 61602.1, 60129.8, 1337.98498424 ],
  [ 1636243200, 61535.4, 63317.8, 63317.8, 61388, 1554.00196888 ],
  [ 1636329600, 63319.6, 67559.8, 67777.7, 63319.6, 3859.96266718 ],
  [ 1636416000, 67550.8, 66745.1, 68495, 66500, 2266.03275444 ] ]