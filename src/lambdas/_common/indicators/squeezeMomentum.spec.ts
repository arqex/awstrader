import { ArrayCandle } from "../../lambda.types";
import { donchianMidline, squeezeMomentum } from "./squeezeMomentum";

describe('donchianMidline', () => {
	it('should return the correct value', () => {
		const highs = [3,4,6,3,4,7,6,5,4,3];
		const lows = [0,1,2,2,3,1,4,0,1,2];
		const candles = getFakeCandles(highs, lows);

		const actual = donchianMidline(candles, 3);
		expect(actual).toEqual([1.5, 2, 3, 3.5, 4, 4, 4, 3.5, 3, 2.5]);
	})
});

// This test is deactivated because the indicator is not stable yet
xdescribe('squeezeMomentum', () => {
	it('should match the test data', () => {
		const actual = squeezeMomentum(testCandles);

		actual.forEach( (ac,i) => {
			if(ac.momentum){
				console.log({
					actual: ac.momentum,
					actualUp: ac.momentum > actual[i-1].momentum,
					expected: expectedSqueeze[i].momentum,
					expectedUp: expectedSqueeze[i].momentum > expectedSqueeze[i-1].momentum
				})
			}
		})

		console.log( actual );
		expect(actual).toEqual(expectedSqueeze);
	})
});


function getFakeCandles( highs, lows ){
	return highs.map( (h,i) => ([0,0,0,h,lows[i],0]));
}


// Data generated by the csvToData.js in the tool folder
const testCandles: ArrayCandle[] = [
	[ 1636299900,
    61863.1,
    61993.8,
    61999.8,
    61855.7,
    15.188579730000011 ],
  [ 1636300800, 61993.7, 62217.5, 62225, 61993.7, 26.416226929999997 ],
  [ 1636301700, 62217.5, 62142.8, 62225, 62101.3, 13.088895379999995 ],
  [ 1636302600, 62142.8, 62258.2, 62258.2, 62115, 17.732405380000017 ],
  [ 1636303500,
    62258.3,
    62084.8,
    62286.9,
    62082.4,
    25.43414638000001 ],
  [ 1636304400,
    62084.8,
    62117.1,
    62159.5,
    62084.8,
    3.7824995600000006 ],
  [ 1636305300, 62117.2, 62210.2, 62210.2, 62117, 3.5286306000000027 ],
  [ 1636306200, 62206.7, 62250, 62250, 62199, 3.0245856700000013 ],
  [ 1636307100, 62250, 62490, 62490, 62249.9, 40.26415510000007 ],
  [ 1636308000,
    62489.9,
    62197.2,
    62554.8,
    62151.3,
    39.78832130999999 ],
  [ 1636308900, 62197.2, 62298, 62298, 62176.3, 10.374146890000006 ],
  [ 1636309800, 62298, 62470.4, 62472.1, 62291.2, 45.20078532000001 ],
  [ 1636310700,
    62473.4,
    62473.8,
    62473.8,
    62380.9,
    46.156193700000024 ],
  [ 1636311600, 62473.8, 62511.1, 62525, 62473, 7.30023058 ],
  [ 1636312500, 62511.1, 62388.9, 62511.1, 62379.5, 3.76763166 ],
  [ 1636313400, 62387.5, 62290, 62387.5, 62290, 11.59370847999999 ],
  [ 1636314300, 62290, 62329.6, 62330.6, 62232.6, 19.696658069999994 ],
  [ 1636315200, 62329.7, 62262.4, 62340, 62250, 10.758997910000007 ],
  [ 1636316100, 62260.5, 62425, 62425, 62260.5, 5.01057129 ],
  [ 1636317000, 62424.9, 62472.1, 62474, 62375.4, 11.040188149999997 ],
  [ 1636317900, 62473.8, 62687.3, 62817, 62473.8, 32.979932439999985 ],
  [ 1636318800,
    62702.2,
    62786.9,
    62851.1,
    62696.9,
    13.382770929999985 ],
  [ 1636319700, 62786.9, 62928.8, 62929, 62786.9, 26.703529019999973 ],
  [ 1636320600, 62928.8, 62890.6, 63090, 62859.9, 108.57187519999994 ],
  [ 1636321500, 62880.3, 62879, 62898.9, 62782.8, 30.167273599999977 ],
  [ 1636322400, 62888.7, 62818, 63030, 62812.1, 33.43905356999994 ],
  [ 1636323300, 62820, 62922.3, 62951.6, 62820, 11.808189529999998 ],
  [ 1636324200,
    62922.3,
    62962.9,
    63000.7,
    62880.5,
    21.354987169999987 ],
  [ 1636325100, 62957.5, 62835, 62975.7, 62833.6, 27.743814919999984 ],
  [ 1636326000, 62834.9, 62831.1, 62950, 62826.3, 11.663860639999996 ],
  [ 1636326900, 62831.1, 62990, 62999.3, 62831, 3.0599859400000025 ],
  [ 1636327800, 62989.9, 62920.1, 63038, 62913.6, 5.301243440000003 ],
  [ 1636328700, 62920.1, 63317.8, 63317.8, 62920, 24.530865429999945 ],
  [ 1636329600, 63319.6, 63878.8, 63879, 63319.6, 153.36504123000017 ],
  [ 1636330500, 63878.8, 64300.7, 64600, 63870, 194.2365430500003 ],
  [ 1636331400, 64291.9, 64866.8, 65002, 64291.9, 138.95139901999997 ],
  [ 1636332300, 64846.3, 64985, 64985, 64680, 88.8131741099999 ],
  [ 1636333200, 64985, 65234.1, 65681.1, 64984.9, 144.20589549999974 ],
  [ 1636334100,
    65228.9,
    65319.3,
    65388.5,
    65021.5,
    64.87019680999991 ],
  [ 1636335000,
    65316.1,
    65042.9,
    65329.3,
    65027.2,
    83.65927082999991 ],
  [ 1636335900, 65043.9, 65141.8, 65220, 65043.8, 17.071434459999985 ],
  [ 1636336800, 65140, 65202, 65310, 65139.9, 43.859346620000025 ],
  [ 1636337700, 65202, 65338, 65373.8, 65202, 42.47240387999998 ],
  [ 1636338600, 65338, 65278, 65338, 65154.7, 25.725503940000003 ],
  [ 1636339500,
    65278.4,
    65132.5,
    65278.4,
    65120.4,
    17.206657279999995 ],
  [ 1636340400,
    65132.6,
    65146.2,
    65150.7,
    65099.9,
    46.09832015000003 ],
  [ 1636341300,
    65146.1,
    65055.5,
    65146.1,
    65051.3,
    23.54773274999996 ],
  [ 1636342200,
    65055.6,
    65164.8,
    65164.8,
    65055.5,
    15.253510619999991 ],
  [ 1636343100,
    65173.8,
    65224.5,
    65257.5,
    65173.8,
    13.70208395999999 ],
  [ 1636344000, 65224.6, 65265.8, 65305.8, 65164.3, 9.08224753999999 ],
  [ 1636344900,
    65265.9,
    65279.9,
    65303.8,
    65265.8,
    7.726961840000002 ],
  [ 1636345800, 65279.9, 65378.1, 65388.5, 65250, 12.433011809999996 ],
  [ 1636346700,
    65378.1,
    65198.4,
    65378.1,
    65132.1,
    36.165421040000005 ],
  [ 1636347600,
    65198.4,
    65294.5,
    65294.8,
    65150.8,
    8.468727400000006 ],
  [ 1636348500,
    65294.5,
    65454.6,
    65703.5,
    65294.5,
    46.27365518000008 ],
  [ 1636349400, 65454.6, 65293.7, 65454.6, 65291, 23.977156470000008 ],
  [ 1636350300, 65329.6, 65476.3, 65629.9, 65329.6, 19.63226972 ],
  [ 1636351200,
    65480.4,
    65751.5,
    65833.9,
    65408.1,
    44.566214900000006 ],
  [ 1636352100,
    65751.4,
    66011.3,
    66157.2,
    65678.6,
    67.30014354000001 ],
  [ 1636353000, 66013.1, 66050.1, 66155, 65872, 30.85908116000002 ],
  [ 1636353900, 66050, 65994.9, 66072.8, 65911.2, 31.445053149999993 ],
  [ 1636354800, 65976.3, 66084.1, 66391.6, 65949.8, 61.0992652399999 ],
  [ 1636355700,
    66087.1,
    65872.9,
    66087.1,
    65861.5,
    47.49783333000002 ],
  [ 1636356600,
    65872.9,
    65736.8,
    65903.1,
    65651.3,
    45.53280878000007 ],
  [ 1636357500, 65758.1, 65983.9, 66000, 65758.1, 29.19999581 ],
  [ 1636358400, 65981.5, 65800, 65981.5, 65800, 26.55504553000004 ],
  [ 1636359300, 65800.1, 65780, 65899, 65780, 36.18089352000011 ],
  [ 1636360200, 65780, 65798.8, 65798.8, 65652.2, 20.73140408 ],
  [ 1636361100,
    65799.8,
    66280.2,
    66283.4,
    65799.8,
    32.513371210000045 ],
  [ 1636362000, 66280.1, 66364.1, 66420, 66123.1, 23.261521200000008 ],
  [ 1636362900,
    66357.8,
    66096.9,
    66357.8,
    66087.7,
    31.76470131999999 ],
  [ 1636363800, 66097, 66182.5, 66251.7, 66049.9, 37.48966230000001 ],
  [ 1636364700, 66176.6, 66125.3, 66273.7, 66100, 40.039108750000004 ],
  [ 1636365600, 66111, 66008.2, 66132.3, 65992.2, 11.210057609999987 ],
  [ 1636366500,
    66008.2,
    65873.2,
    66030.6,
    65765.8,
    25.239105199999994 ],
  [ 1636367400, 65873.1, 65959.2, 66000, 65865.1, 18.980604239999987 ],
  [ 1636368300, 65944.5, 66042.2, 66073.7, 65904.9, 11.64425285 ],
  [ 1636369200, 66042.2, 65855, 66083.6, 65855, 35.767952610000016 ],
  [ 1636370100, 65855, 65845.7, 65917.9, 65798, 16.09304778999999 ],
  [ 1636371000,
    65845.6,
    65916.8,
    66038.3,
    65828.6,
    21.373376779999965 ],
  [ 1636371900, 65916.9, 66055.2, 66063, 65826.2, 7.253871969999998 ],
  [ 1636372800,
    66063.1,
    65880.7,
    66163.6,
    65875.7,
    26.32575092999997 ],
  [ 1636373700, 65880.8, 65913, 65998.3, 65875, 20.06612377999997 ],
  [ 1636374600,
    65912.9,
    65928.7,
    65989.5,
    65850.1,
    16.82864084999999 ],
  [ 1636375500, 65928.6, 65837.5, 65961.6, 65791.6, 25.25387081 ],
  [ 1636376400,
    65842.4,
    65876.2,
    65995.8,
    65842.3,
    6.331165210000006 ],
  [ 1636377300, 65876.2, 65881.3, 65907, 65777.5, 21.19332903 ],
  [ 1636378200,
    65882.6,
    65603.6,
    65917.9,
    65458.1,
    56.084411050000014 ],
  [ 1636379100, 65603.7, 65425.2, 65603.7, 65327.3, 53.41785171 ],
  [ 1636380000,
    65425.1,
    65552.6,
    65559.8,
    65425.1,
    19.800561579999986 ],
  [ 1636380900, 65552.5, 65492.4, 65554.3, 65350, 36.86169285 ],
  [ 1636381800,
    65492.5,
    65239.3,
    65492.5,
    65200.1,
    38.60673961000003 ],
  [ 1636382700,
    65239.3,
    65374.7,
    65417.8,
    65239.3,
    21.856181120000013 ],
  [ 1636383600,
    65374.7,
    65589.9,
    65589.9,
    65341.7,
    41.71040791999999 ],
  [ 1636384500,
    65591.1,
    65763.8,
    65776.7,
    65591.1,
    28.26010206999999 ],
  [ 1636385400,
    65763.6,
    66185.2,
    66337.1,
    65763.6,
    63.101175840000074 ],
  [ 1636386300, 66185.2, 66437.4, 66500, 66096.3, 81.15564005000016 ],
  [ 1636387200, 66437.3, 66257.6, 66523.7, 66245, 54.59454430999998 ],
  [ 1636388100, 66256.3, 66045.9, 66256.3, 66019, 57.74497218000007 ],
  [ 1636389000,
    66056.1,
    65918.7,
    66057.6,
    65889.5,
    11.662625580000004 ]
];

const expectedSqueeze = [ { squeeze: false, momentum: -6.622035714281605 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 0 },
  { squeeze: false, momentum: 1548.9363214285895 },
  { squeeze: false, momentum: 1561.2670714285873 },
  { squeeze: false, momentum: 1520.8044285714448 },
  { squeeze: false, momentum: 1454.8392142857306 },
  { squeeze: false, momentum: 1360.8392500000155 },
  { squeeze: false, momentum: 1273.599678571445 },
  { squeeze: false, momentum: 1166.6581785714443 },
  { squeeze: false, momentum: 1045.2724642857293 },
  { squeeze: false, momentum: 916.7237857143026 },
  { squeeze: false, momentum: 781.2545357143032 },
  { squeeze: false, momentum: 610.0977142857332 },
  { squeeze: false, momentum: 465.54846428573387 },
  { squeeze: false, momentum: 352.98882142859156 },
  { squeeze: false, momentum: 242.0027500000208 },
  { squeeze: false, momentum: 174.14371428573872 },
  { squeeze: false, momentum: 167.71832142859785 },
  { squeeze: false, momentum: 206.58967857145717 },
  { squeeze: false, momentum: 225.30085714288793 },
  { squeeze: false, momentum: 236.88250000003052 },
  { squeeze: false, momentum: 258.0004642857448 },
  { squeeze: false, momentum: 254.67185714288598 },
  { squeeze: false, momentum: 225.94225000002803 },
  { squeeze: false, momentum: 232.60517857145703 },
  { squeeze: false, momentum: 205.58950000002926 },
  { squeeze: false, momentum: 167.09467857145944 },
  { squeeze: false, momentum: 139.85032142860507 },
  { squeeze: false, momentum: 206.94385714288802 },
  { squeeze: false, momentum: 284.46635714288834 },
  { squeeze: false, momentum: 304.5314285714578 },
  { squeeze: false, momentum: 345.80985714288505 },
  { squeeze: false, momentum: 343.7347500000264 },
  { squeeze: false, momentum: 304.05189285716915 },
  { squeeze: false, momentum: 242.3533928571673 },
  { squeeze: false, momentum: 170.2324642857381 },
  { squeeze: false, momentum: 117.32075000002334 },
  { squeeze: false, momentum: 41.221500000023866 },
  { squeeze: false, momentum: -11.78235714283295 },
  { squeeze: false, momentum: -39.62435714283083 },
  { squeeze: false, momentum: -40.42007142854624 },
  { squeeze: false, momentum: -65.43582142854609 },
  { squeeze: false, momentum: -98.16610714283257 },
  { squeeze: false, momentum: -138.3953928571202 },
  { squeeze: false, momentum: -169.28624999997777 },
  { squeeze: false, momentum: -205.87739285712098 },
  { squeeze: false, momentum: -241.80339285711943 },
  { squeeze: false, momentum: -317.4957499999742 },
  { squeeze: false, momentum: -364.29507142854476 },
  { squeeze: false, momentum: -361.08721428568526 },
  { squeeze: false, momentum: -377.98028571425687 },
  { squeeze: false, momentum: -415.6786428571154 },
  { squeeze: false, momentum: -415.0140357142593 },
  { squeeze: false, momentum: -380.12610714283363 },
  { squeeze: false, momentum: -323.31842857140697 },
  { squeeze: false, momentum: -192.32296428569634 },
  { squeeze: false, momentum: -24.371107142840287 },
  { squeeze: false, momentum: 74.57889285716044 },
  { squeeze: false, momentum: 124.40275000001765 },
  { squeeze: false, momentum: 152.69532142858787 }
]